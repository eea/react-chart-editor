"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _react=_interopRequireWildcard(require("react"));var _propTypes=_interopRequireDefault(require("prop-types"));var _isNil=_interopRequireDefault(require("lodash/isNil"));var _hyperformula=require("hyperformula");var _base=_interopRequireDefault(require("handsontable/base"));var _lib=require("./lib");var _plugins=require("handsontable/plugins");var _constants=require("./lib/constants");var _dereference=require("./lib/dereference");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r})(e)}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&{}.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u]}return n.default=e,t&&t.set(e,n),n}(function(){var enterModule=typeof reactHotLoaderGlobal!=="undefined"?reactHotLoaderGlobal.enterModule:undefined;enterModule&&enterModule(module)})();function _slicedToArray(r,e){return _arrayWithHoles(r)||_iterableToArrayLimit(r,e)||_unsupportedIterableToArray(r,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return _arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(r,a):void 0}}function _arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}function _iterableToArrayLimit(r,l){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var e,n,i,u,a=[],f=!0,o=!1;try{if(i=(t=t.call(r)).next,0===l){if(Object(t)!==t)return;f=!1}else for(;!(f=(e=i.call(t)).done)&&(a.push(e.value),a.length!==l);f=!0);}catch(r){o=!0,n=r}finally{try{if(!f&&null!=t.return&&(u=t.return(),Object(u)!==u))return}finally{if(o)throw n}}return a}}function _arrayWithHoles(r){if(Array.isArray(r))return r}function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,o)}return t}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach(function(r){_defineProperty(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}function _defineProperty(e,r,t){return(r=_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _toPropertyKey(t){var i=_toPrimitive(t,"string");return"symbol"==typeof i?i:i+""}function _toPrimitive(t,r){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}var __signature__=typeof reactHotLoaderGlobal!=="undefined"?reactHotLoaderGlobal.default.signature:function(a){return a};(0,_plugins.registerPlugin)(_plugins.AutoColumnSize);(0,_plugins.registerPlugin)(_plugins.Autofill);(0,_plugins.registerPlugin)(_plugins.BindRowsWithHeaders);(0,_plugins.registerPlugin)(_plugins.CopyPaste);(0,_plugins.registerPlugin)(_plugins.ContextMenu);(0,_plugins.registerPlugin)(_plugins.DragToScroll);(0,_plugins.registerPlugin)(_plugins.DropdownMenu);(0,_plugins.registerPlugin)(_plugins.Formulas);(0,_plugins.registerPlugin)(_plugins.ManualColumnResize);(0,_plugins.registerPlugin)(_plugins.UndoRedo);var MIN_ROWS=20;var MIN_COLS=26;function getContextMenuItemTrigger(hot,name,trigger){var _hot$getPlugin$itemsF;return(_hot$getPlugin$itemsF=hot.getPlugin("ContextMenu").itemsFactory.predefinedItems[name])===null||_hot$getPlugin$itemsF===void 0||(_hot$getPlugin$itemsF=_hot$getPlugin$itemsF[trigger])===null||_hot$getPlugin$itemsF===void 0?void 0:_hot$getPlugin$itemsF.bind(hot)}class DataSourcesEditor extends _react.Component{constructor(){super();this.hot=null;this.colHeaders=null;this.tableEl=_react.default.createRef();this.previewEl=_react.default.createRef();this.deserialize=this.deserialize.bind(this);this.serialize=this.serialize.bind(this);this.onUpdate=this.onUpdate.bind(this);this.isSingleColumnSelected=this.isSingleColumnSelected.bind(this);this.renameColumn=this.renameColumn.bind(this)}componentDidMount(){this.colHeaders=Object.keys(this.props.dataSources||{});var self=this;var data=this.deserialize();var contextMenu={items:{row_above:{name:"Insert row(s) above",hidden(){return getContextMenuItemTrigger(this,"row_above","disabled")()},callback(){var rows=Number(prompt("Enter number of rows:",1))||1;var latestSelection=this.getSelectedRangeLast().getTopRightCorner();this.alter("insert_row_above",latestSelection.row,rows,"ContextMenu.rowAbove")}},row_below:{name:"Insert row(s) below",hidden(){return getContextMenuItemTrigger(this,"row_below","disabled")()},callback(){var rows=Number(prompt("Enter number of rows:",1))||1;var latestSelection=this.getSelectedRangeLast().getBottomRightCorner();this.alter("insert_row_below",latestSelection.row,rows,"ContextMenu.rowBelow")}},col_left:{name:"Insert cols(s) to the left",hidden(){return getContextMenuItemTrigger(this,"col_left","disabled")()},callback(){var cols=Number(prompt("Enter number of columns:",1))||1;var latestSelection=this.getSelectedRangeLast().getTopLeftCorner();var alterAction=this.isRtl()?"insert_col_end":"insert_col_start";this.alter(alterAction,latestSelection.col,cols,"ContextMenu.columnLeft")}},col_right:{name:"Insert cols(s) to the right",hidden(){return getContextMenuItemTrigger(this,"col_right","disabled")()},callback(){var cols=Number(prompt("Enter number of columns:",1))||1;var latestSelection=this.getSelectedRangeLast().getTopRightCorner();var alterAction=this.isRtl()?"insert_col_start":"insert_col_end";this.alter(alterAction,latestSelection.col,cols,"ContextMenu.columnRight")}},sp1:"---------",rename_col:{name:"Rename column",hidden(){return!self.isSingleColumnSelected(this)},disabled(){return!self.isSingleColumnSelected(this)},callback(){self.renameColumn(this.getSelectedLast()[1])}},remove_row:{hidden(){return getContextMenuItemTrigger(this,"remove_row","disabled")()}},remove_col:{hidden(){return getContextMenuItemTrigger(this,"remove_col","disabled")()}},clear_column:{hidden(){return getContextMenuItemTrigger(this,"clear_column","disabled")()||!self.isSingleColumnSelected(this)}},sp2:"---------",undo:"undo",redo:"redo"}};this.hot=new _base.default(this.tableEl.current,_objectSpread(_objectSpread({},data.length?{data}:{}),{},{width:"100%",height:320,rowHeaders:true,colHeaders:this.colHeaders,minRows:MIN_ROWS,minCols:Math.max(MIN_COLS,this.colHeaders.length),autoWrapRow:true,autoWrapCol:true,contextMenu,autoColumnSize:{useHeaders:true},fillHandle:"vertical",licenseKey:"non-commercial-and-evaluation",bindRowsWithHeaders:true,copyPaste:true,manualColumnMove:true,manualColumnResize:true,formulas:{engine:_hyperformula.HyperFormula},afterChange(changes,source){if(source==="loadData"){return}self.onUpdate({editedColumns:changes.map(change=>self.colHeaders[change[1]])})},afterUpdateSettings(settings){if(settings.colHeaders&&settings.colHeaders.length===self.colHeaders.length){self.onUpdate({renamedColumns:self.colHeaders.reduce((acc,header,index)=>{if(header!==settings.colHeaders[index]){acc.push(index)}return acc},[])})}if(settings.colHeaders&&settings.colHeaders.length!==self.colHeaders.length){self.onUpdate({removedColumns:self.colHeaders.reduce((acc,header)=>{if(!settings.colHeaders.includes(header)){acc.push(header)}return acc},[])})}},afterCreateCol(index,amount){self.onUpdate({createdColumns:Array.from({length:amount},(_,i)=>index+i)})},afterCreateRow(index,amount){self.onUpdate({createdRows:Array.from({length:amount},(_,i)=>index+i)})},afterRemoveCol(index,amount){var columns=Array.from({length:amount},(_,i)=>index+i);self.onUpdate({removedColumns:columns.map(index=>self.colHeaders[index])})},afterRemoveRow(){self.onUpdate({editedColumns:self.colHeaders})},afterOnCellMouseDown(e,coords){var _e$target;var isButton=((_e$target=e.target)===null||_e$target===void 0?void 0:_e$target.nodeName)==="BUTTON";if(coords.row>-1||coords.col===-1||e.detail!==2||isButton){return}setTimeout(()=>{self.renameColumn(coords.col)},100)},init:()=>{window.dispatchEvent(new Event("resize"))}}))}componentWillUnmount(){var _this$hot;(_this$hot=this.hot)===null||_this$hot===void 0||_this$hot.destroy()}deserialize(){var col=0;return Object.entries(this.props.dataSources||{}).reduce((acc,_ref)=>{var _ref2=_slicedToArray(_ref,2),_=_ref2[0],value=_ref2[1];value.forEach((_,i)=>{if(!acc[i]){acc[i]=[]}acc[i][col]=value[i]});++col;return acc},[])}serialize(){var dataSources={};var data=this.hot.getData();this.colHeaders=this.hot.getColHeader();this.colHeaders.forEach((header,i)=>{var emptyRange=[-1,-1];var colData=data.map((row,j)=>{if((0,_isNil.default)(row[i])){emptyRange[1]=j+1}else{emptyRange[0]=j+1;emptyRange[1]=j+1}return row[i]});if(emptyRange[0]===-1||!colData.length){return}var emptyRows=emptyRange[1]-emptyRange[0];if(emptyRows>0&&emptyRows===colData.length){return}if(emptyRows>0&&emptyRange[1]===colData.length){dataSources[header]=colData.slice(0,emptyRange[0])}else{dataSources[header]=colData}});return dataSources}onUpdate(changes){requestAnimationFrame(()=>{var update={layout:{},traces:[]};var prevColHeaders=this.colHeaders;var dataSources=this.serialize();var dataSourceOptions=Object.keys(dataSources).map(name=>({value:name,label:name}));var _changes$editedColumn=changes.editedColumns,editedColumns=_changes$editedColumn===void 0?[]:_changes$editedColumn,_changes$renamedColum=changes.renamedColumns,renamedColumns=_changes$renamedColum===void 0?[]:_changes$renamedColum,_changes$removedColum=changes.removedColumns,removedColumns=_changes$removedColum===void 0?[]:_changes$removedColum;var attrs=[...this.props.data.reduce((acc,trace,index)=>{Object.entries((0,_lib.getAttrsPath)(trace,_constants.TRACE_SRC_ATTRIBUTES)).forEach(_ref3=>{var _ref4=_slicedToArray(_ref3,1),attr=_ref4[0];acc.push({attr,index,trace:true})});return acc},[]),...Object.entries((0,_lib.getAttrsPath)(this.props.layout,_constants.LAYOUT_SRC_ATTRIBUTES)).reduce((acc,_ref5)=>{var _ref6=_slicedToArray(_ref5,1),attr=_ref6[0];acc.push({attr,layout:true});return acc},[])];attrs.forEach(_ref7=>{var attr=_ref7.attr,trace=_ref7.trace,layout=_ref7.layout,index=_ref7.index;function updateAttr(attr,value){if(trace&&!update.traces[index]){update.traces[index]={}}if(trace){update.traces[index][attr]=value}if(layout){update.layout[attr]=value}}var container=trace?this.props.data[index]:this.props.layout;var srcAttr=(0,_lib.getSrcAttr)(container,attr,this.props.srcConverters);editedColumns.forEach(col=>{if((0,_lib.inSrcAttr)(srcAttr,col)){var data=(0,_lib.getData)(container,srcAttr,dataSources);updateAttr(attr,data)}});renamedColumns.forEach(colIndex=>{var oldCol=prevColHeaders[colIndex];var newCol=this.colHeaders[colIndex];if((0,_lib.inSrcAttr)(srcAttr,oldCol)){if(Array.isArray(srcAttr.value)){srcAttr.value=srcAttr.value.reduce((acc,value)=>{if(value===oldCol){acc.push(newCol)}else{acc.push(value)}return acc},[]);updateAttr(srcAttr.key,srcAttr.value);updateAttr("meta.columnNames.".concat(attr),(0,_dereference.getColumnNames)(srcAttr.value,dataSourceOptions))}if(typeof srcAttr.value==="string"&&srcAttr.value===oldCol){srcAttr.value=newCol;updateAttr(srcAttr.key,newCol);updateAttr("meta.columnNames.".concat(attr),(0,_dereference.getColumnNames)([srcAttr.value],dataSourceOptions))}}});removedColumns.forEach(col=>{if((0,_lib.inSrcAttr)(srcAttr,col)){var data;if(Array.isArray(srcAttr.value)){srcAttr.value=srcAttr.value.filter(value=>value!==col);data=(0,_lib.getData)(container,srcAttr,dataSources)}if(typeof srcAttr.value==="string"&&srcAttr.value===col){srcAttr.value=null;data=null}updateAttr(srcAttr.key,srcAttr.value);updateAttr(attr,data)}})});update.traces.forEach((update,i)=>{if(!Object.keys(update).length){return}this.props.onUpdate({type:_constants.EDITOR_ACTIONS.UPDATE_TRACES,payload:{update,traceIndexes:[i]}})});if(Object.keys(update.layout).length){this.props.onUpdate({type:_constants.EDITOR_ACTIONS.UPDATE_LAYOUT,payload:{update:update.layout}})}this.props.onUpdate({type:_constants.EDITOR_ACTIONS.UPDATE_DATA_SOURCES,payload:{dataSources}})})}isSingleColumnSelected(){var ranges=this.hot.getSelectedRange()||[];var start=Infinity;var end=-Infinity;ranges.forEach(cellRange=>{if(cellRange.from.col<start){start=cellRange.from.col}if(cellRange.to.col>end){end=cellRange.to.col}});return ranges.length&&start-end===0}renameColumn(colIndex){var colHeaders=this.hot.getColHeader();var newColHeader=prompt("Enter new column name:",colHeaders[colIndex]);if(!newColHeader){return}colHeaders[colIndex]=newColHeader;this.hot.updateSettings({colHeaders})}render(){return _react.default.createElement(_react.default.Fragment,null,_react.default.createElement("div",{className:"grid_panel"},_react.default.createElement("div",{className:"ht-table-wrapper ht-theme-main"},_react.default.createElement("div",{className:"border border-top"}),_react.default.createElement("div",{className:"border border-bottom"}),_react.default.createElement("div",{className:"border border-left"}),_react.default.createElement("div",{className:"border border-right"}),_react.default.createElement("div",{ref:this.tableEl}))),_react.default.createElement("div",{className:"grid_panel__resize-bar",onMouseDown:e=>{e.preventDefault();var startY=e.clientY;var startHeight=this.hot.getSettings().height;var height=startHeight;var handleMouseMove=e=>{e.preventDefault();var deltaY=e.clientY-startY;this.previewEl.current.style.top=deltaY+"px";height=Math.max(_constants.MIN_GRID_HEIGHT,startHeight+deltaY)};var handleMouseUp=()=>{document.removeEventListener("mousemove",handleMouseMove);document.removeEventListener("mouseup",handleMouseUp);this.previewEl.current.style.top="0px";this.hot.updateSettings({height});requestAnimationFrame(()=>{this.props.onPlotResize()})};document.addEventListener("mousemove",handleMouseMove);document.addEventListener("mouseup",handleMouseUp)}},_react.default.createElement("div",{className:"grid_panel__resize-divider"}),_react.default.createElement("div",{className:"grid_panel__resize-preview",ref:this.previewEl})))}__reactstandin__regenerateByEval(key,code){this[key]=eval(code)}}DataSourcesEditor.propTypes={data:_propTypes.default.array,layout:_propTypes.default.object,dataSources:_propTypes.default.object,srcConverters:_propTypes.default.shape({toSrc:_propTypes.default.func.isRequired,fromSrc:_propTypes.default.func.isRequired}),onUpdate:_propTypes.default.func,onPlotResize:_propTypes.default.func};var _default=DataSourcesEditor;var _default2=exports.default=_default;;(function(){var reactHotLoader=typeof reactHotLoaderGlobal!=="undefined"?reactHotLoaderGlobal.default:undefined;if(!reactHotLoader){return}reactHotLoader.register(MIN_ROWS,"MIN_ROWS","/Users/razvan/Work/react-chart-editor/src/DataSourcesEditor.js");reactHotLoader.register(MIN_COLS,"MIN_COLS","/Users/razvan/Work/react-chart-editor/src/DataSourcesEditor.js");reactHotLoader.register(getContextMenuItemTrigger,"getContextMenuItemTrigger","/Users/razvan/Work/react-chart-editor/src/DataSourcesEditor.js");reactHotLoader.register(DataSourcesEditor,"DataSourcesEditor","/Users/razvan/Work/react-chart-editor/src/DataSourcesEditor.js");reactHotLoader.register(_default,"default","/Users/razvan/Work/react-chart-editor/src/DataSourcesEditor.js")})();;(function(){var leaveModule=typeof reactHotLoaderGlobal!=="undefined"?reactHotLoaderGlobal.leaveModule:undefined;leaveModule&&leaveModule(module)})();
//# sourceMappingURL=DataSourcesEditor.js.map